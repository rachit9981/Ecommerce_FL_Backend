name: Python Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          REMOTE_REPO_DIR: /root/Ecommerce_FL_Backend
          REMOTE_VENV_DIR: /root/Ecommerce_FL_Backend/venv
          GIT_URL: https://github.com/rachit9981/Ecommerce_FL_Backend.git
          GUNICORN_SERVICE: gunicorn
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" \
          ssh -o StrictHostKeyChecking=no "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
          "REMOTE_REPO_DIR='$REMOTE_REPO_DIR' REMOTE_VENV_DIR='$REMOTE_VENV_DIR' GIT_URL='$GIT_URL' GUNICORN_SERVICE='$GUNICORN_SERVICE'" \
          bash -s <<'EOSSH'
            set -e

            # â”€â”€ 1. Oneâ€‘time: trust GitHub host key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            mkdir -p ~/.ssh
            if ! grep -q github.com ~/.ssh/known_hosts 2>/dev/null; then
              ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> ~/.ssh/known_hosts 2>/dev/null
            fi

            # â”€â”€ 2. Clone or update repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ“ Ensuring repo folder existsâ€¦"
            mkdir -p "$REMOTE_REPO_DIR"
            cd "$REMOTE_REPO_DIR"

            if [ ! -d .git ]; then
              echo "ğŸ”° First-time cloneâ€¦"
              git clone "$GIT_URL" .
            else
              echo "ğŸ”„ Pulling latest codeâ€¦"
              git remote set-url origin "$GIT_URL"
              git fetch --prune
              git reset --hard origin/main
            fi

            # â”€â”€ 3. Update venv & dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            source "$REMOTE_VENV_DIR/bin/activate"
            pip install --upgrade pip
            pip install --upgrade -r requirements.txt

            # â”€â”€ 4. Apply migrations & collect static files (optional) â”€â”€â”€â”€â”€â”€
            cd "$REMOTE_REPO_DIR"
            python manage.py makemigrations
            python manage.py migrate

            # â”€â”€ 5. Restart Gunicorn systemd service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ”„ Restarting Gunicorn service '$GUNICORN_SERVICE'â€¦"
            sudo systemctl daemon-reload
            sudo systemctl restart "$GUNICORN_SERVICE"
            sudo systemctl status "$GUNICORN_SERVICE" --no-pager

            echo "âœ… Backend deployed & Gunicorn restarted."
          EOSSH
