# .github/workflows/backend-deploy.yml
name: Python Backend CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server via SSH
        env:
          REMOTE_REPO_DIR: /root/deploy/Ecommerce_FL_Backend
          REMOTE_VENV_DIR: /root/venvs/backend_env
          TMUX_SESSION: backend_session
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<EOF
            set -e

            echo "ðŸ“  Repo path: \$REMOTE_REPO_DIR"
            mkdir -p "$REMOTE_REPO_DIR"

            echo "ðŸ”„  Pulling latest code"
            cd "$REMOTE_REPO_DIR"
            if [ ! -d .git ]; then
              git clone https://github.com/LazyyVenom/Ecommerce_FL_Backend.git "$REMOTE_REPO_DIR"
            else
              git reset --hard
              git pull origin main
            fi

            echo "ðŸ  Updating Python deps"
            source "$REMOTE_VENV_DIR/bin/activate"
            pip install --upgrade -r requirements.txt

            echo "ðŸŒ€  Restarting tmux session '$TMUX_SESSION'"
            if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
              tmux kill-session -t "$TMUX_SESSION"
            fi

            tmux new-session -d -s "$TMUX_SESSION" \
              "source '$REMOTE_VENV_DIR/bin/activate' && cd '$REMOTE_REPO_DIR' && gunicorn main:app --bind 0.0.0.0:8000"

            echo "âœ…  Backend deployed and running"
EOF
