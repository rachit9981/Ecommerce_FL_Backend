name: Python Backend CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          REMOTE_REPO_DIR: /root/deploy/Ecommerce_FL_Backend
          REMOTE_VENV_DIR: /root/venvs/backend_env
          TMUX_SESSION: backend_session
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -s << 'EOSSH'
            set -e

            echo "📁  Ensuring repo folder exists..."
            mkdir -p /root/deploy/Ecommerce_FL_Backend

            cd /root/deploy/Ecommerce_FL_Backend

            if [ ! -d .git ]; then
              echo "🔰  First-time clone..."
              git clone git@github.com:LazyyVenom/Ecommerce_FL_Backend.git .
            else
              echo "🔄  Pulling latest code..."
              git remote set-url origin git@github.com:LazyyVenom/Ecommerce_FL_Backend.git
              git reset --hard
              git pull origin main
            fi

            echo "🐍  Updating Python deps..."
            source /root/venvs/backend_env/bin/activate
            pip install --upgrade -r requirements.txt

            echo "🎬  Restarting tmux session..."
            if tmux has-session -t backend_session 2>/dev/null; then
              tmux kill-session -t backend_session
            fi

            tmux new-session -d -s backend_session \
              "cd /root/deploy/Ecommerce_FL_Backend && source /root/venvs/backend_env/bin/activate && gunicorn main:app --bind 0.0.0.0:8000"

            echo "✅  Backend deployed and running."
          EOSSH
